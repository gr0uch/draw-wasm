const proxyMarker=Symbol("Comlink.proxy"),createEndpoint=Symbol("Comlink.endpoint"),releaseProxy=Symbol("Comlink.releaseProxy"),throwMarker=Symbol("Comlink.thrown"),isObject=e=>"object"==typeof e&&null!==e||"function"==typeof e,proxyTransferHandler={canHandle:e=>isObject(e)&&e[proxyMarker],serialize(e){const{port1:r,port2:t}=new MessageChannel;return expose(e,r),[t,[t]]},deserialize:e=>(e.start(),wrap(e))},throwTransferHandler={canHandle:e=>isObject(e)&&throwMarker in e,serialize({value:e}){let r;return[r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}},transferHandlers=new Map([["proxy",proxyTransferHandler],["throw",throwTransferHandler]]);function expose(e,r=self){r.addEventListener("message",function t(n){if(!n||!n.data)return;const{id:a,type:s,path:o}=Object.assign({path:[]},n.data),i=(n.data.argumentList||[]).map(fromWireValue);let c;try{const r=o.slice(0,-1).reduce((e,r)=>e[r],e),t=o.reduce((e,r)=>e[r],e);switch(s){case"GET":c=t;break;case"SET":r[o.slice(-1)[0]]=fromWireValue(n.data.value),c=!0;break;case"APPLY":c=t.apply(r,i);break;case"CONSTRUCT":c=proxy(new t(...i));break;case"ENDPOINT":{const{port1:r,port2:t}=new MessageChannel;expose(e,t),c=transfer(r,[r])}break;case"RELEASE":c=void 0;break;default:return}}catch(e){c={value:e,[throwMarker]:0}}Promise.resolve(c).catch(e=>({value:e,[throwMarker]:0})).then(e=>{const[n,o]=toWireValue(e);r.postMessage(Object.assign(Object.assign({},n),{id:a}),o),"RELEASE"===s&&(r.removeEventListener("message",t),closeEndPoint(r))})}),r.start&&r.start()}function isMessagePort(e){return"MessagePort"===e.constructor.name}function closeEndPoint(e){isMessagePort(e)&&e.close()}function wrap(e,r){return createProxy(e,[],r)}function throwIfProxyReleased(e){if(e)throw new Error("Proxy has been released and is not useable")}function createProxy(e,r=[],t=function(){}){let n=!1;const a=new Proxy(t,{get(t,s){if(throwIfProxyReleased(n),s===releaseProxy)return()=>requestResponseMessage(e,{type:"RELEASE",path:r.map(e=>e.toString())}).then(()=>{closeEndPoint(e),n=!0});if("then"===s){if(0===r.length)return{then:()=>a};const t=requestResponseMessage(e,{type:"GET",path:r.map(e=>e.toString())}).then(fromWireValue);return t.then.bind(t)}return createProxy(e,[...r,s])},set(t,a,s){throwIfProxyReleased(n);const[o,i]=toWireValue(s);return requestResponseMessage(e,{type:"SET",path:[...r,a].map(e=>e.toString()),value:o},i).then(fromWireValue)},apply(t,a,s){throwIfProxyReleased(n);const o=r[r.length-1];if(o===createEndpoint)return requestResponseMessage(e,{type:"ENDPOINT"}).then(fromWireValue);if("bind"===o)return createProxy(e,r.slice(0,-1));const[i,c]=processArguments(s);return requestResponseMessage(e,{type:"APPLY",path:r.map(e=>e.toString()),argumentList:i},c).then(fromWireValue)},construct(t,a){throwIfProxyReleased(n);const[s,o]=processArguments(a);return requestResponseMessage(e,{type:"CONSTRUCT",path:r.map(e=>e.toString()),argumentList:s},o).then(fromWireValue)}});return a}function myFlat(e){return Array.prototype.concat.apply([],e)}function processArguments(e){const r=e.map(toWireValue);return[r.map(e=>e[0]),myFlat(r.map(e=>e[1]))]}const transferCache=new WeakMap;function transfer(e,r){return transferCache.set(e,r),e}function proxy(e){return Object.assign(e,{[proxyMarker]:!0})}function windowEndpoint(e,r=self,t="*"){return{postMessage:(r,n)=>e.postMessage(r,t,n),addEventListener:r.addEventListener.bind(r),removeEventListener:r.removeEventListener.bind(r)}}function toWireValue(e){for(const[r,t]of transferHandlers)if(t.canHandle(e)){const[n,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:n},a]}return[{type:"RAW",value:e},transferCache.get(e)||[]]}function fromWireValue(e){switch(e.type){case"HANDLER":return transferHandlers.get(e.name).deserialize(e.value);case"RAW":return e.value}}function requestResponseMessage(e,r,t){return new Promise(n=>{const a=generateUUID();e.addEventListener("message",function r(t){t.data&&t.data.id&&t.data.id===a&&(e.removeEventListener("message",r),n(t.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:a},r),t)})}function generateUUID(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}export{createEndpoint,expose,proxy,proxyMarker,releaseProxy,transfer,transferHandlers,windowEndpoint,wrap};
